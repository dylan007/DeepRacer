import math


racing_line = [[2.12670866, 1.16303719],
               [2.2139788, 1.1557589],
               [2.3029206, 1.15471325],
               [2.3932255, 1.15948262],
               [2.48461715, 1.16956027],
               [2.57685379, 1.18435706],
               [2.66972671, 1.20320232],
               [2.76309481, 1.22562496],
               [2.85684585, 1.25117456],
               [2.9508898, 1.27939429],
               [3.04519153, 1.31021002],
               [3.1426613, 1.33953866],
               [3.24039561, 1.36637884],
               [3.33839418, 1.39039448],
               [3.43663389, 1.41142175],
               [3.53509097, 1.42927506],
               [3.63374511, 1.4436243],
               [3.73256444, 1.45420148],
               [3.8315124, 1.46067039],
               [3.93054146, 1.46280227],
               [4.02959743, 1.460481],
               [4.1286243, 1.45370343],
               [4.22756901, 1.44258018],
               [4.32638574, 1.42733358],
               [4.42503939, 1.40829534],
               [4.52350751, 1.38590263],
               [4.62176984, 1.36053828],
               [4.71978656, 1.33239972],
               [4.81749862, 1.30173947],
               [4.91467352, 1.26853554],
               [5.0089439, 1.23345955],
               [5.09771621, 1.20332746],
               [5.1847222, 1.17684045],
               [5.27076655, 1.15393912],
               [5.35604505, 1.13482436],
               [5.44052798, 1.11993436],
               [5.52414977, 1.10948254],
               [5.60677795, 1.10381086],
               [5.68828173, 1.10312149],
               [5.76845871, 1.10780939],
               [5.84707002, 1.11826715],
               [5.92386331, 1.13479445],
               [5.99857359, 1.15760487],
               [6.07092631, 1.18682859],
               [6.14064317, 1.22251054],
               [6.20744872, 1.26461201],
               [6.27107731, 1.31301601],
               [6.33128009, 1.36753477],
               [6.38783181, 1.42791841],
               [6.44053688, 1.49386387],
               [6.48923408, 1.56502407],
               [6.53379958, 1.64101685],
               [6.57414773, 1.72143351],
               [6.61022958, 1.80584671],
               [6.64202905, 1.89381757],
               [6.66955704, 1.98490161],
               [6.69284386, 2.07865356],
               [6.7119306, 2.17463079],
               [6.7268601, 2.27239532],
               [6.73766832, 2.37151461],
               [6.74437673, 2.47156102],
               [6.74698643, 2.5721103],
               [6.74547442, 2.67273933],
               [6.73979245, 2.77302334],
               [6.72986838, 2.87253302],
               [6.71561026, 2.97083185],
               [6.69691255, 3.06747401],
               [6.67366432, 3.16200311],
               [6.64575872, 3.25395218],
               [6.61310311, 3.34284502],
               [6.57562923, 3.42819914],
               [6.53330261, 3.50953045],
               [6.48613064, 3.58635959],
               [6.43416883, 3.65821997],
               [6.37752466, 3.72466739],
               [6.31635969, 3.78529238],
               [6.25090181, 3.83975766],
               [6.18152793, 3.88797811],
               [6.10876002, 3.93022786],
               [6.03258968, 3.9658559],
               [5.95278879, 3.99340867],
               [5.86997413, 4.0131022],
               [5.78485948, 4.02585699],
               [5.69785428, 4.0321162],
               [5.60935797, 4.03259155],
               [5.51961972, 4.02767984],
               [5.42881085, 4.01758654],
               [5.3371355, 4.00285428],
               [5.24476474, 3.98410396],
               [5.15183104, 3.96197473],
               [5.05837869, 3.93675895],
               [4.96442645, 3.90874875],
               [4.86994932, 3.87812327],
               [4.77185799, 3.84881527],
               [4.67349106, 3.82207592],
               [4.57487831, 3.7980786],
               [4.47604113, 3.77710326],
               [4.37701444, 3.75925419],
               [4.27782275, 3.74485071],
               [4.17850022, 3.73415825],
               [4.07908587, 3.72748641],
               [3.97962737, 3.72505525],
               [3.88017793, 3.72697614],
               [3.78079162, 3.73325051],
               [3.68151857, 3.74376939],
               [3.58240009, 3.75831489],
               [3.48346431, 3.77656316],
               [3.38472256, 3.7980872],
               [3.28616677, 3.82235688],
               [3.18776721, 3.84872221],
               [3.08948702, 3.87658456],
               [2.9912914, 3.90545672],
               [2.89710262, 3.93260048],
               [2.80306682, 3.95832551],
               [2.70929891, 3.98177256],
               [2.61592896, 4.00218336],
               [2.52313052, 4.01874259],
               [2.43110379, 4.03076488],
               [2.34009435, 4.03759727],
               [2.25038237, 4.0386942],
               [2.16227812, 4.03362438],
               [2.07611745, 4.02206048],
               [1.99225474, 4.00377335],
               [1.91105374, 3.9786291],
               [1.83287724, 3.94658639],
               [1.75807618, 3.90769271],
               [1.68697897, 3.86207917],
               [1.61988167, 3.80995352],
               [1.55703963, 3.7515917],
               [1.49866121, 3.68732816],
               [1.444904, 3.61754541],
               [1.39587377, 3.54266338],
               [1.35162621, 3.46312907],
               [1.31217147, 3.37940692],
               [1.27748103, 3.29197046],
               [1.24749648, 3.2012953],
               [1.22213964, 3.10785391],
               [1.2013232, 3.01211204],
               [1.18496118, 2.91452685],
               [1.17297852, 2.81554656],
               [1.165319, 2.71561149],
               [1.16195119, 2.61515604],
               [1.16287177, 2.51461148],
               [1.16810629, 2.414409],
               [1.17770716, 2.31498287],
               [1.1917491, 2.21677319],
               [1.21032244, 2.12022805],
               [1.23352462, 2.02580468],
               [1.26145051, 1.93396947],
               [1.29418219, 1.84519657],
               [1.33177886, 1.75996498],
               [1.37426739, 1.67875395],
               [1.42163438, 1.60203683],
               [1.47381992, 1.53027325],
               [1.53071375, 1.46389997],
               [1.5921539, 1.40332046],
               [1.65792796, 1.34889378],
               [1.72777703, 1.30092293],
               [1.80140198, 1.25964358],
               [1.87837168, 1.22499015],
               [1.95854502, 1.19748042],
               [2.04151955, 1.17708194],
               [2.12670866, 1.16303719]]


def calc_speed_reward(speed):
    min_speed = 1.33 * 1.33
    max_speed = 4 * 4
    speed *= speed
    return (speed - min_speed)/(max_speed - min_speed)


def dist(a, b):
    return (a[0] - b[0])**2 + (a[1] - b[1])**2


def reward_function(params):
    '''
    Example of rewarding the agent to follow center line
    '''
    max_dist = params['track_width'] ** 2

    if not params['all_wheels_on_track']:
        return 1e-3

    # penalize non stationary action
    if params['speed'] < 1.33:
        return 1e-3

    rewards = dict.fromkeys(
        ['dist_racing_line', 'speed'], 0.0)
    weights = dict.fromkeys(
        ['dist_racing_line', 'speed'], 1000.0)

    weights['speed'] = 400
    weights['dist_racing_line'] = 800

    current_point = [params['x'], params['y']]
    distances = [dist(current_point, x) for x in racing_line]
    distances.sort()

    rewards['dist_racing_line'] = (
        distances[0]/max_dist) * weights['dist_racing_line']
    rewards['speed'] = calc_speed_reward(params['speed']) * weights['speed']

    return sum(rewards.values())
